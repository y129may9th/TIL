[イケてるエンジニアになろうシリーズ 〜メモリとプロセスとスレッド編〜](https://moro-archive.hatenablog.com/entry/2014/09/11/013520)

## マルチタスクOS

- 同時に複数の機能が動く
- CPUの数だけプログラムを同時に実行できる
- マルチタスクの機能によって、実行するアプリを細かくきりかえる（同時に動いているようにみせてる）

## プロセス

- 実行されているアプリケーション

## メモリ

- 情報保持

  プログラム（プロセスこ）が利用する情報がすべてメモリに入れてから使う

  - 画面に表示する画像

  - キーボードから入力された文字

  - ハードディスクやUSBメモリに保存したファイル

  - 通信して受け取ったデータ

    など

- プログラム実行時にメモリだけ見ればうごく(データの元の場所は関係ない)

- CPUはメモリのデータをみて演算処理を行う

  （メモリのデータの出し入れはOSが用意：デバイスドライバ）

## 物理アドレスと仮想アドレス空間

- メモリは1Byte単位ですべての領域にアドレスが振られている
- 1GBのメモリ = 1 * 1024 * 1024 * 1024 = 2^30個
- メモリのアドレスを指定してデータの読み書きする（プロセスが動く）
- メモリの管理＝プロセッサのMMU（Memory Management Unit）

### MMU

- プロセスごとに専用の物理メモリ領域を確保

- 物理領域に仮想アドレスを用意（物理領域へのアクセス用）

  プロセス

  - 仮想アドレスを指定（メモリアクセス）
  - 仮想アドレス  -> 物理アドレスの解決（MMU）

- プロセスは物理領域を意識することなく独立したメモリ空間を利用できる

- それぞれのプロセスは任意のアドレスを利用（セキュリティ）

- メモリの隙間を有効に使える(仮想空間は連続した領域、メモリ上は分散した領域を使う、とかできる)

### コンピュータのメモリ容量

- メモリアドレスで扱う数値の桁数に依存
  - 32ビットシステム：2^32Byte = 4GByte
  - 64ビットシステム：2^64Byte = 172億GByte

## プロセスがメモリに保存してる情報

プロセスは2つのセグメントに分かれた構造のデータをメモリ上に持つ

### テキストセグメント

- プログラムの命令（実行されるプログラム）※読み取り専用

### データセグメント

- PDA(Processor Data Area)

  - プロセッサの情報やプロセス管理用のデータ領域
  - スタックポインタ：スタック領域のさす場所を示す値
  - プログラムカウンタ：プログラムの実行位置をさす値

- データ領域

  - 静的領域

    - 定数やグローバル変数が置かれるところ

  - ヒープ領域

    - 通常の変数などが格納される領域

      プロセスが領域を増やしたり、減らしたりする（サイズ不明）

  - スタック領域

    - 引数やローカルスコープのデータなどを一時的に置くところ

### プロセスがデータ構造を持ってメモリ上に存在している



## プロセスとスレッドの違い

### プロセス

- 親 fork 子
  - 子
    - プログラムは親と同じ（テキストセグメントを共有）
    - データセグメントは親のコピー（変数が実行状況で変わるから）
    - Webブラウザを何個か開くかんじ？

## スレッド

プロセスからスレッドを生成する

同じプログラムを並列に動かす

- 親 pthread_create スレッド
  - 仮想アドレス内　以下の値をスレッドごとにコピーして利用
    - スタック領域
    - SP
    - PC
  - その他は親を参照
  - ほぼすべてのデータを他のスレッドと共有する
    - あるスレッドが利用しようとする変数がほかのスレッドによって書き換え、削除が起こる
    - 問題が発生しないプログラム -> スレッドセーフ

## パフォーマンスの違い

- プロセスは専用のメモリ領域を利用
  - ぷろせすのそれぞれに専用のアドレス空間を保持
  - 仮想アドレス⇔物理アドレス　のマッピングの切り替えが必要になる
- スレッドは共有のメモリ領域を利用
  - スレッドが持つデータはすべて親プロセスのメモリ領域内に保持
  - 仮想空間の切り替えが必要ない





