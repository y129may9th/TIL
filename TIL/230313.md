# Cloud Functions ã§ MySQL (GCP CloudSQL)ã«æ¥ç¶šã—ã€æ¤œç´¢ã€ç™»éŒ²ã‚’è©¦ã™

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€å‚è€ƒ
- [ã‚¢ãƒ—ãƒªã‹ã‚‰é–¢æ•°ã‚’å‘¼ã³å‡ºã™ &nbsp;|&nbsp; Cloud Functions for Firebase](https://firebase.google.com/docs/functions/callable?hl=ja)
- [Cloud Functions ã‹ã‚‰æ¥ç¶šã™ã‚‹ &nbsp;|&nbsp; Cloud SQL for MySQL &nbsp;|&nbsp; Google Cloud](https://cloud.google.com/sql/docs/mysql/connect-functions?hl=ja)
- [Firebaseã¨Flutterã§ã‚¢ãƒ—ãƒªé–‹ç™ºã—ã¦ã¿ã‚‹ã€å…¶ãƒä¸€ï¼šCloudFunctionsã§ã®å‡¦ç†ç¯‡ã€‘ - Qiita](https://qiita.com/nunnally_engr_0114/items/adf7e9fbd41224e5f8dc)

## Firebase Cloud Functionsã®ç’°å¢ƒå¤‰æ•°è¨­å®š
  ### 1. Firebase CLIã§ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã™ã‚‹
  - åˆå›ã¯ã€`â€”project` ãŒãªã„ã¨ãƒ€ãƒ¡ã ã£ãŸã€‚project ãŒè¤‡æ•°ã‚ã‚‹ã‹ã‚‰ï¼Ÿ
  ```bash
    $ firebase functions:config:get --project <project å>
    $ {}
  ```

  ### 2. MySQLã®æ¥ç¶šæƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹
  ```bash
    $ firebase functions:config:set --project <app å> mysql.instance_connection_name=project:region:instance-id
    $ firebase functions:config:set --project <app å> mysql.user=<userå>
    $ firebase functions:config:set --project <app å> mysql.password=<password>$ firebase functions:config:set --project <app å> mysql.password=<password>
    firebase functions:config:set --project <app å> mysql.database_name=<dbå>
  ```
  - é–“é•ãˆãŸã¨ã
  ```bash
  $ firebase functions:config:unset [key]
  ```

## CloudFunctionsç’°å¢ƒæ§‹ç¯‰
### 1. Firebase Functionsã‚’åˆæœŸåŒ–ã™ã‚‹
```bash
$ firebase init functions
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
### `[promise-mysql](https://www.npmjs.com/package/promise-mysql)` ã‚’ä½¿ã†
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹ promise-mysql ã«ã™ã‚‹
  - [https://www.npmjs.com/package/promise-mysql](https://www.npmjs.com/package/promise-mysql)
  ```bash
    npm i promise-mysql --save
    npm install @types/mysql --save
  ```
  - é•ã„ã¯ã“ã¡ã‚‰ ğŸ‘‰Â [mysqlã¨mysql-promiseã®é•ã„ã«ã¤ã„ã¦](https://zenn.dev/msksgm/articles/20211123-node-promisemysql-mysql)

## ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  Node.js ã‚’ä½¿ã£ã¦ã€TypeScript ã§ã‹ã
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    - [Cloud Functions ã« TypeScript ã‚’ä½¿ç”¨ã™ã‚‹Â | Cloud Functions for Firebase](https://firebase.google.com/docs/functions/typescript?hl=ja)

    ### Sample
    - [functions-framework-nodejs/typescript.md at master Â· GoogleCloudPlatform/functions-framework-nodejs Â· GitHub](https://github.com/GoogleCloudPlatform/functions-framework-nodejs/tree/master/docs)
    - [TypeScript ã§ google cloud functions ã‚’ä½¿ã† - Qiita](https://qiita.com/hidemotoNakada/items/0b27e150b4211e3f4497)
    - [Functions Frameworkã§TypeScriptã‚’ä½¿ã„ã¤ã¤Cloud Functionsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - Qiita](https://qiita.com/mokichi/items/c2dd9db3d093dbbdc1be)

## é–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤
- [ã‚¢ãƒ—ãƒªã‹ã‚‰é–¢æ•°ã‚’å‘¼ã³å‡ºã™Â | Cloud Functions for Firebase](https://firebase.google.com/docs/functions/callable?hl=ja)
  ```bash
  $ firebase deploy --only functions:addMessage
  ```
### â–  ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©
[Cloud Functions ã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³Â | Cloud Functions for Firebase](https://firebase.google.com/docs/functions/locations?hl=ja)
- [Cloud Functions for Firebase å‘¨ã‚Šã®Tips](https://zenn.dev/welchi/scraps/635b92f1195871)

### â–  TS å‘¨ã‚Šã®ã‚¨ãƒ©ãƒ¼
**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ãƒ©ãƒ¼**
  - å‚è€ƒï¼š[TypeScript ã® esModuleInterop ãƒ•ãƒ©ã‚°ã«ã¤ã„ã¦ - 30æ­³ã‹ã‚‰ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°](https://numb86-tech.hatenablog.com/entry/2020/07/11/160159)
  - ã‚¨ãƒ©ãƒ¼å†…å®¹
    ```bash
      node_modules/promise-mysql/index.d.ts:2:8 - error TS1259: Module '"/Users/onishi_yui/repos/fc-scout-app/functions/node_modules/@types/bluebird/index"' can only be default-imported using the 'esModuleInterop' flag

      2 import Bluebird from 'bluebird';
              ~~~~~~~~
      node_modules/@types/bluebird/index.d.ts:1298:1
      1298 export = Bluebird;
          ~~~~~~~~~~~~~~~~~~
      This module is declared with 'export =', and can only be used with a default import when using the 'esModuleInterop' flag.

      Found 1 error in node_modules/promise-mysql/index.d.ts:2
    ```
    - `default`ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ CommonJS å½¢å¼ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã€ES Modules ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã­ã¨ã®ã“ã¨ï¼Ÿ
      - CommonJS ã¯ requireã§èª­ã¿è¾¼ã¾ãªã‘ã‚Œã°ãªã‚‰ãªã„
        - `import Bluebird = require('bluebird')` ã“ã‚“æ„Ÿã˜ï¼Ÿ
      - ES Modules ã§ã¯ã€import fromå¥ã ã‹ã‚‰å¤‰æ›ãŒå¿…è¦ã£ã¦ã“ã¨ï¼Ÿ

  - å¯¾å¿œ
    - `"esModuleInterop": true`  ã“ã‚Œã‚’è¿½åŠ 
    ```json
    // tsconfig.json
    {
      "compilerOptions": {
        "module": "commonjs",
        "noImplicitReturns": true,
        "noUnusedLocals": true,
        "outDir": "lib",
        "sourceMap": true,
        "strict": true,
        "target": "es2017",
        "esModuleInterop": true //ã“ã‚Œè¿½åŠ 
      },
      "compileOnSave": true,
      "include": [
        "src"
      ]
    }
    ```

  - **ã‚ˆã‚€**
    - [TypeScriptã®`-esModuleInterop`ã¯ä¸€ä½“ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã®ã‹ - stone's throw](https://osamtimizer.hatenablog.com/entry/2018/06/28/122502)
    - [ã‚ˆãåˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ã§CommonJSã¨TypeScriptã®ES Modulesinteropã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸ // ãƒ‘ã‚±ãƒƒãƒˆç•‘ã§ã¤ã‹ã¾ãˆã¦](https://omochizo.netlify.app/posts/2020/08/commonjs-esm/)
    - [ãªãœJavaScriptã«ã¯2ã¤ã‚‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿ(ES Modulesã¨CommonJS) Â· Issue #527 Â· yytypescript/book Â· GitHub](https://github.com/yytypescript/book/issues/527)

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‘¨ã‚Šã®ã‚¨ãƒ©ãƒ¼**
  - `Parsing error: Cannot read file tsconfig.json`
    - [VS Code ESLint æ‹¡å¼µãŒ Parsing error: Cannot read file ã‚¨ãƒ©ãƒ¼ config ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å•é¡Œã«ãƒãƒã‚‹ - ã‹ã‚‚ãƒ¡ãƒ¢](https://chaika.hatenablog.com/entry/2020/09/23/083000)

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
  - [TypeScript ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è€ƒãˆã‚‹ - Qiita](https://qiita.com/frozenbonito/items/e708dfb3ab7c1fd3824d)

### â–  **ã‚‚ã‚ã‚‚ã‚å‚è€ƒ**
- å¤§ä½“ã“ã®è¨˜äº‹ã®ã‚¨ãƒ©ãƒ¼ã‚’è¸ã‚“ã§ã„ã£ãŸ
    - [firebase deploy â€“only functions:### ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚ŠFunctionsã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããªã„ | halzo appdev blog](https://halzoblog.com/error-bug-diary/20221114-2/)
- [VSCode ä¸Šã§ã® ESLint ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆ](https://zenn.dev/taichifukumoto/scraps/45be5ffdfa8457)
- [Next.js ESLint ã§ TypeScript ã®ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ãŸã„ - ã‹ã‚‚ãƒ¡ãƒ¢](https://chaika.hatenablog.com/entry/2023/02/28/090000)


## https.onCall() ãƒˆãƒªã‚¬ãƒ¼ã§ã‚¢ãƒ—ãƒªã‹ã‚‰é–¢æ•°ã‚’å‘¼ã³å‡ºã™
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  [https.onCall ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜ Â |Â  Cloud Functions for Firebase](https://firebase.google.com/docs/functions/callable-reference?hl=ja)

### Sample
- user é–¢æ•°ã‚’ä½œã‚‹
- `data`ã«ã¯é€ä¿¡ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€`context`ã«ã¯Firebase Authenticationã«ã‚ˆã‚‹èªè¨¼æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    - é€šå¸¸èªè¨¼æƒ…å ±ã‚’ä»˜ä¸ã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€Authentication Headerã« bearer tokenã¨ã„ã£ãŸå½¢ã§ä»˜ä¸ã—ã¦æ¤œè¨¼ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ã“ã®ã‚ˆã†ãªã‚ã‚“ã©ãã•ã„æ±ºã¾ã‚Šãã£ãŸå‡¦ç†ã‚’ã™ã¹ã¦è¡Œã£ã¦ãã‚Œã¾ã™ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã«ã¯ã€JSONã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã‚’returnã™ã‚‹ã€‚
- ã‚¨ãƒ©ãƒ¼å‡¦ç†
  - `https.HttpsError`ã‚’ã‚¹ãƒ­ãƒ¼
  - `https.HttpsError`ã®ç¬¬ä¸€å¼•æ•°ã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã€ç¬¬äºŒå¼•æ•°ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸¡ã™ã€‚
  - ç¬¬ä¸€å¼•æ•°ã«æ¸¡ã›ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
> FunctionsErrorCode: "ok" | "cancelled" | "unknown" | "invalid-argument" | "deadline-exceeded" | "not-found" | "already-exists" | "permission-denied" | "resource-exhausted" | "failed-precondition" | "aborted" | "out-of-range" | "unimplemented" | "internal" | "unavailable" | "data-loss" | "unauthenticatedâ€
            >
  - [functions | JavaScript SDKÂ | Node.js (client) API referenceÂ | Firebase](https://firebase.google.com/docs/reference/node/firebase.functions#functionserrorcode)
  - [javascript - Throwing new functions.https.HttpsError on Firebase Cloud Function rejects as Internal Error on Client - Stack Overflow](https://stackoverflow.com/questions/50936424/throwing-new-functions-https-httpserror-on-firebase-cloud-function-rejects-as-in)

```jsx
    import { https } from 'firebase-functions'

    export const user = https.onCall(async (data, context) => {
      if (!context.auth) {
        throw new https.HttpsError('unauthenticated', 'auth error')
      }
      const user = await User.find(context.auth.uid)

      return {
        firstName: user.firstName,
        lastName: user.lastName,
        age: user.age
       }
    })
```
- [Firebase Functions https.onCall()ãƒˆãƒªã‚¬ãƒ¼ã§ã‚¢ãƒ—ãƒªã‹ã‚‰ç°¡å˜ã«å‘¼ã³å‡ºã™](https://azukiazusa.dev/blog/firebase-functions-https-oncall/#oncall%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B)


## ï¼ˆä½™è«‡ï¼‰https.onRequest() ã‚’ä½¿ã†
### Sample
- [ReactFirebaseBook/01-env/mangarel-demo at master Â· oukayuka/ReactFirebaseBook Â· GitHub](https://github.com/oukayuka/ReactFirebaseBook/tree/master/01-env/mangarel-demo)
- æ¯”è¼ƒ
  - [How to work with Firebase Cloud Functions from a Flutter app](https://quickcoder.org/firebase-functions/)
  - [javascript - Firebase Cloud Functions: Difference between onRequest and onCall - Stack Overflow](https://stackoverflow.com/questions/51066434/firebase-cloud-functions-difference-between-onrequest-and-oncall)
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  - [http | Dart Package](https://pub.dev/packages/http)


## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
### ./ios/Podfile ã®ã‚¨ãƒ©ãƒ¼
  - å¯¾å¿œ
> `firebase_core` ã¯iOSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‘ï¼‘ã‚’è¦æ±‚ã—ã¦ã‚‹ã®ã§ã€`./ios/Podfile` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚
  ```swift
  # Uncomment this line to define a global platform for your project
  platform :ios, '11.0' ## ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
  ...
  ```
  - podfile æ›´æ–°
    ```bash
    cd ios
    pod install --repo-update
    ```

### `Your client does not have permission to get URL /helloWorld from this server` ã¨ãªã£ã¦ã€ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
- æœªèªè¨¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‘¼ã³å‡ºã—ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
  [Firebase functionsã§ 403 error "Your client does not have permission to get URL /** from this server" ã¨ãªã£ãŸå ´åˆã®è§£æ±ºç­– - Qiita](https://qiita.com/toshiaki_takase/items/ce65cd5582a80917b52f)
> 2020å¹´1æœˆ15æ—¥æ™‚ç‚¹ã‚ˆã‚Šã€Cloud Functionsã®é–¢æ•°ã«é–¢ã—ã¦ã€æœªèªè¨¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‘¼ã³å‡ºã—ã§ããªã„ç”¨ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ï¼ˆãã‚Œã¾ã§ã¯ã€æœªèªè¨¼ã§ã‚‚é–¢æ•°å‘¼ã³å‡ºã—å®Ÿè¡Œã§ããŸãŒä»Šã¯è¨­å®šã—ãªã„ã¨ã§ããªã„ï¼‰
- æœªèªè¨¼ã¨ã¯â€¦?
  - é©åˆ‡ãªæ¨©é™ã®ãªã„ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã“ã¨ã ã¨æ€ã†ã€‚
> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€HTTP é–¢æ•°ã‚’**å‘¼ã³å‡ºã™**å¿…è¦ãŒã‚ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã€èªè¨¼æƒ…å ±ï¼ˆID ã®è¨¼æ˜ï¼‰ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã€å¿…è¦ãªæ¨©é™ã‚’ä¿æŒã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã—ã€èªè¨¼è¦ä»¶ã¯[ç„¡åŠ¹](https://cloud.google.com/functions/docs/securing/managing-access-iam?hl=ja#allowing_unauthenticated_http_function_invocation)ã«ã§ãã¾ã™ã€‚é©åˆ‡ãªèªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã¦æç¤ºã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è©³ã—ãã¯ã€[å‘¼ã³å‡ºã—ã®èªè¨¼](https://cloud.google.com/functions/docs/securing/authenticating?hl=ja)ã‚’ã”è¦§ãã ã•ã„ã€‚

[IAM ã‚’ä½¿ç”¨ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ã®æ‰¿èª Â |Â  Google Cloud Functions ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/functions/docs/securing/managing-access-iam?hl=ja#allowing_unauthenticated_function_invocation)

- æœªèªè¨¼ã§å‘¼ã³å‡ºã™æ–¹æ³•
  - [èªè¨¼ã•ã‚Œã¦ã„ãªã„ HTTP é–¢æ•°ã®å‘¼ã³å‡ºã—ã‚’è¨±å¯ã™ã‚‹](https://cloud.google.com/functions/docs/securing/managing-access-iam?hl=ja#console_4)
  - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
    - **allUsers** ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã« **Cloud Functions èµ·å‹•å…ƒ** ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã€‚
    - å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Cloud Functionsã®èµ·å‹•å…ƒã®æ¨©é™ã‚’ä»˜ä¸ã§ãã‚‹ã¨ã„ã†è¨­å®šã€‚
    - è£œè¶³
      - `allUsers`ã«ã™ã‚‹ã¨ã€åŸºæœ¬å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–¢æ•°ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãŒèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«åˆ¶é™ã—ãŸã„å ´åˆã¯`allAuthenticatedUsers`ã«ã™ã‚‹ã¨ã‚ˆã„
      - gcloud
        ```bash
        gcloud functions add-iam-policy-binding <FUNCTION_NAME> \
        Â --member="allUsers" \
        Â --role="roles/cloudfunctions.invoker"
        ```
      - [HTTP ãƒˆãƒªã‚¬ãƒ¼ Â |Â  Google Cloud Functions ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/functions/docs/calling/http?hl=ja)

**é–¢é€£**
- [Cloud Functions ã®å‘¼ã³å‡ºã—ã‚’è¨±å¯ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†åˆ¶å¾¡ã™ã‚‹æ–¹æ³• - G-gen Tech Blog](https://blog.g-gen.co.jp/entry/authenticated-invocation-of-cloud-functions)

### é–¢æ•°å®Ÿè¡Œå¾Œã« `{"error":{"message":"Bad Request","status":"INVALID_ARGUMENT"}}` ã®ã‚¨ãƒ©ãƒ¼
- http onCallã®é–¢æ•°ã‚’å®Ÿè¡Œã—ãŸæ™‚ã«ä¸Šè¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã®å¯¾å‡¦æ³•ã€‚
  - **JSONå½¢å¼ã§Â `data`Â è¦ç´ ã‚’æŒãŸã›ã‚‹ã€‚**
    ```json
    {
      "data": {
        "hoge": 'ã“ã“ã«ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹',
        "fuga": 'JSONã®å½¢å¼ã§"data"è¦ç´ ã‚’æŒã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹'
      }
    }
    ```
    [Cloud Functions ã®é–¢æ•°ã®ç›´æ¥å‘¼ã³å‡ºã— Â |Â  Google Cloud Functions ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/functions/docs/running/direct?hl=ja)
    - [GCPã®Cloud Functionsã®é–¢æ•°ã‚’ç›´æ¥å®Ÿè¡Œã™ã‚‹æ–¹æ³•](https://zenn.dev/tokiya_horikawa/articles/fe701aaca5dbb4)
    - [Cloud Functions for Firebaseã§Request has invalid method. GETã‹Bad Request, INVALID_ARGUMENTãªã‚‰ã“ã‚Œã‹ã‚‚ï¼Ÿ - Qiita](https://qiita.com/qrusadorz/items/f1d71e591a598d30ab9e)

### ã‚¢ãƒ—ãƒªã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã¨ **`UNAUTHENTICATED`** ã®ã‚¨ãƒ©ãƒ¼
- [Newly Created Firebase Functions Throwing UNAUTHENTICATED Error - Stack Overflow](https://stackoverflow.com/questions/61151247/newly-created-firebase-functions-throwing-unauthenticated-error)
- App Check ã‚’å°å…¥ã™ã‚‹

## App Check
- Functions ã« allUser ã®æ¨©é™ã‚’ã¤ã‘ã‚‹ã¨ã€ã‚¢ã‚¯ã‚»ã‚¹è¶…éã§æ–™é‡‘çˆ†ä¸ŠãŒã‚Šã™ã‚‹ã®ã§ã€App Check ã‚’è¨­å®šã™ã‚‹
  - allUser ã‚’ä»˜ä¸ã—ã¦ã€é©åˆ‡ã«ã‚«ãƒãƒ¼ã™ã‚‹ã—ã‹ãªã„ã‚ˆãªãƒ¼
    - [Restrict Access to HTTPS Callable Cloud Function](https://www.googlecloudcommunity.com/gc/Serverless/Restrict-Access-to-HTTPS-Callable-Cloud-Function/m-p/482563)
        > Keep in mind that Google Cloud IAM is not available to public applications using Firebase, so having allUsers as Cloud Function Invoker
        >
        >
        > [is required](https://stackoverflow.com/a/61965312/16929894)
        >

    - AppCheck ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
      - [Flutter ã‚¢ãƒ—ãƒªã§ App Check ã‚’ä½¿ã£ã¦ã¿ã‚‹ &nbsp;|&nbsp; Firebase ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/app-check/flutter/default-providers?hl=ja)Â (edited)
      - [Cloud Functions ã®é–¢æ•°ã§ App Check ã®é©ç”¨ã‚’æœ‰åŠ¹ã«ã™ã‚‹ &nbsp;|&nbsp; Firebase App Check](https://firebase.google.com/docs/app-check/cloud-functions?hl=ja)

### ãƒ‡ãƒãƒƒã‚°ç”¨
- [Flutter ã§ App Check ã¨ãƒ‡ãƒãƒƒã‚° ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ç”¨ã™ã‚‹ &nbsp;|&nbsp; Firebase App Check](https://firebase.google.com/docs/app-check/flutter/debug-provider?hl=ja)
- **ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³å–ã‚Œãªã„**
  - Xcode ã®Â `build settings`Â  ->Â `Swift Compiler â€“ Custom Flags`Â  ->Â `Active Compilation Conditions` ã«ã¦ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ãŠãã¨ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
  - å‚è€ƒ
    - [ã€Flutterã€‘Firebase App Checkã‚’è©¦ã™ï½œHiroki Yoshiiï½œnote](https://note.com/rect_angle/n/n27899e6ce00f)
    - [[Xcode] Xcode 8.0ã‹ã‚‰ã€ŒActive Compilation Conditionsã€ãŒè¿½åŠ ã•ã‚Œã¦#if, #elseif, #else, #endifã«ã‚ˆã‚‹åˆ†å²è¨­å®šãŒã¡ã‚‡ã£ã¨æ¥½ã«ãªã£ã¦ã¾ã™ | DevelopersIO](https://dev.classmethod.jp/articles/xcode-8-active-compilation-conditions/)

- **ã‚ˆãã‚ã‹ã‚‰ã‚“è¨­å®šå‘¨ã‚Šã«ã¤ã„ã¦èª¿ã¹ãŸã“ã¨**
  - `#if DEBUG`ã‚’ä½¿ã†ã¨ãƒ‡ãƒãƒƒã‚°ç‰ˆã§ã®ã¿å‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹
    ```swift
    #if DEBUG
    // ãƒ‡ãƒãƒƒã‚°ç‰ˆã§ã®ã¿è¡Œã„ãŸã„å‡¦ç†
    #endif
    ```
    - if ã®æ¡ä»¶ã‚’ä¸Šã® Xcode è¨­å®šã§ãƒ•ãƒ©ã‚°ã¨ã—ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„`#if RELEASE`Â  ã¨ã—ãŸã„ã¨ãã¯ã€Xcode è¨­å®šã§ãƒªãƒ¼ã‚¹ç‰ˆç”¨ã®ãƒ•ãƒ©ã‚°ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„ã€‚
    [Swift: ãƒªãƒªãƒ¼ã‚¹ç‰ˆã§ã®ã¿å‡¦ç†ã‚’è¡Œã†](https://zenn.dev/kyome/articles/0b6a689776c9c69b4026)

  - å‚è€ƒ
    - [[Xcode] Xcode 8.0ã‹ã‚‰ã€ŒActive Compilation Conditionsã€ãŒè¿½åŠ ã•ã‚Œã¦#if, #elseif, #else, #endifã«ã‚ˆã‚‹åˆ†å²è¨­å®šãŒã¡ã‚‡ã£ã¨æ¥½ã«ãªã£ã¦ã¾ã™ | DevelopersIO](https://dev.classmethod.jp/articles/xcode-8-active-compilation-conditions/)
    - ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ **AppCheck åŠ¹ã„ã¦ã‚“ã®ã‹åŠ¹ã„ã¦ãªã„ã®ã‹**
      - ä¸€åº¦ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç¢ºèªã™ã‚‹
      > æ³¨:ãƒ‡ãƒãƒƒã‚° ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ã€æœ€åˆã®ã‚¢ãƒ—ãƒªã®èµ·å‹•æ™‚ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨ã«ç”Ÿæˆã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å®šå€¤ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã—ãŸã‚Šã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸã‚Šã€åˆ¥ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚Šã™ã‚‹ã¨ã€æ–°ã—ã„ãƒ‡ãƒãƒƒã‚° ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚å¿…ãšæ–°ã—ã„ãƒ‡ãƒãƒƒã‚° ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
      [Appleãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®Firebaseã‚¢ãƒ—ãƒªãƒã‚§ãƒƒã‚¯](https://firebase.google.com/codelabs/app-attest?hl=ja#7)

- ã‚„ã£ãŸã“ã¨ã¾ã¨ã‚
  - æ¡ä»¶
    ```bash
    - allUser æ¨©é™ä»˜ä¸
    - debug ãƒˆãƒ¼ã‚¯ãƒ³ã‚»ãƒƒãƒˆæ¸ˆã¿
    ```
  - ãƒ†ã‚¹ãƒˆ
    ```bash
    - curl ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã¯ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦å®Ÿè¡Œã§ããªã„... Appcheck ãŒåŠ¹ã„ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ï¼Ÿ
    - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
      - debug ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‹ã®æƒ…å ±ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã€Funcions ãŒå®Ÿè¡Œã§ããªããªã‚‹
      - æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œã•ã‚Œã‚‹
      - æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚»ãƒƒãƒˆã™ã‚‹ã¨ã€Functions å®Ÿè¡Œã§ããŸãƒ¼
    - ã‚¢ãƒ—ãƒªå‰Šé™¤ã—ã¦å†ãƒ“ãƒ«ãƒ‰
      - debug ãƒˆãƒ¼ã‚¯ãƒ³ãŒå†ç™ºè¡Œã•ã‚Œã‚‹
      - Functions ã®å®Ÿè¡Œã¯ã§ãã¦ã—ã¾ã£ã¦ã„ãŸ
    ```

    - ã“ã¡ã‚‰ã‚‚ã‚„ã‚‹
      ```bash
      cd ios/
      rm Podfile.lock
      pod install
      cd ..
      ```

- **ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–ã‚Œãªããªã£ãŸæ™‚ï¼ˆå†ï¼‰**
  - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
    - `No app has been configured yet.` ã¨ã‹ã§æ¤œç´¢ã—ã¦ã„ã
    ```bash
      2023-03-13 19:01:55.396558+0900 Runner[63962:443546] Metal API Validation Enabled
      2023-03-13 19:01:55.455359+0900 Runner[63962:443673] flutter: The Dart VM service is listening on http://127.0.0.1:64662/Evajcf4FIcU=/
      2023-03-13 19:01:55.498752+0900 Runner[63962:443637] 10.3.0 - [FirebaseCore][I-COR000005] No app has been configured yet.
      2023-03-13 19:01:55.498964+0900 Runner[63962:443637] 10.3.0 - [FirebaseCore][I-COR000001] Configuring the default app.
      2023-03-13 19:01:55.502481+0900 Runner[63962:443638] 10.3.0 - [FirebaseCore][I-COR000033] Data Collection flag is not set.
      2023-03-13 19:01:55.503172+0900 Runner[63962:443638] 10.3.0 - [GoogleUtilities/AppDelegateSwizzler][I-SWZ001008] Successfully created App Delegate Proxy automatically. To disable the proxy, set the flag GoogleUtilitiesAppDelegateProxyEnabled to NO (Boolean) in the Info.plist
    ```
  - ios/Runner/AppDelegate.swift ã«ä¸€è¡Œè¿½åŠ 
    ```swift
    FirebaseApp.configure() //ã“ã®ä¸€è¡Œã‚’è¿½åŠ 
    ```
  - çµæœ
    ```bash
      2023-03-13 19:15:40.381774+0900 Runner[65250:458235] Metal API Validation Enabled
      2023-03-13 19:15:40.534886+0900 Runner[65250:458456] flutter: The Dart VM service is listening on http://127.0.0.1:65172/Qcdz6G1WNRc=/
      2023-03-13 19:15:40.537717+0900 Runner[65250:458416] 10.3.0 - [FirebaseCore][I-COR000001] Configuring the default app.
      2023-03-13 19:15:40.556044+0900 Runner[65250:458416] 10.3.0 - [GoogleUtilities/AppDelegateSwizzler][I-SWZ001008] Successfully created App Delegate Proxy automatically. To disable the proxy, set the flag GoogleUtilitiesAppDelegateProxyEnabled to NO (Boolean) in the Info.plist
      2023-03-13 19:15:40.556391+0900 Runner[65250:458416] 10.3.0 - [FirebaseAppCheck][I-FAA005001] Firebase App Check debug token: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'.
      2023-03-13 19:15:40.562767+0900 Runner[65250:458416] 10.3.0 - [FirebaseCore][I-COR000033] Data Collection flag is not set.
    ```
  - å‚è€ƒ
    - [ã€Flutterã€‘No app has been configured yet.ã€€ã¨å‡ºã¦ããŸæ™‚ã®å¯¾å‡¦æ³•](https://zenn.dev/wakanao/articles/32d3e8bb553258)
    - [Flutter ã§ App Check ã¨ãƒ‡ãƒãƒƒã‚° ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ç”¨ã™ã‚‹Â | Firebase App Check](https://firebase.google.com/docs/app-check/flutter/debug-provider?hl=ja) ã§ã¯ã€ä¸è¦ãã†ã ã£ãŸã‘ã‚Œã©ã€[Apple ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ App Check ã¨ãƒ‡ãƒãƒƒã‚° ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ç”¨ã™ã‚‹Â | Firebase App Check](https://firebase.google.com/docs/app-check/ios/debug-provider?authuser=0&hl=ja#swift) ã ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ãŸã®ã§ã€è¿½è¨˜ã—ãŸã‚‰ã§ããŸã€‚
    - [iOSã‚¢ãƒ—ãƒªé–‹ç™ºã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤æ–¹æ³•ã¾ã¨ã‚ - Qiita](https://qiita.com/shtnkgm/items/c96a58579ec406194fa8)
    - [ã€Flutterã€‘å€‹äººçš„ã€Œãªã‚“ã‹ã‚ã£ãŸã‚‰ã‚³ãƒ¬ã€ãƒªã‚¹ãƒˆ](https://zenn.dev/mamushi/articles/flutter_command_tips)
    - [Flutterã§Firebase AppCheckã®DebugProviderã§ãƒãƒã£ãŸ](https://zenn.dev/fukutan/articles/f490d25d15a891)
    - [ios - My Flutter/Firebase app is showing no app has been configured yet - Stack Overflow](https://stackoverflow.com/questions/64014893/my-flutter-firebase-app-is-showing-no-app-has-been-configured-yet)
    - [Firebase Analyticsã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒãƒƒã‚°æ–¹æ³•(iOS) - Qiita](https://qiita.com/KenNagami/items/48d3fea8f616fd60e3e4)

## ã»ã‹

- [Google Cloud Functionsã‚’CLIã§å‹•ã‹ã™ã¾ã§ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | nansystem](https://nansystem.com/troubleshooting-googe-cloud-functions/)

### Samples
- [PaPaPointã‚¢ãƒ—ãƒªã€CloudFunctionsè¨­å®šç·¨ã€‘ | bellbellbell.info](https://bellbellbell.info/2020/11/papapoint-cloud-firestore/)
